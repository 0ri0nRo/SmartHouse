<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping List</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #334155;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 100vw;
            margin: 0;
            padding: 12px;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            margin-bottom: 16px;
            padding: 16px 8px;
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #4f46e5;
            margin-bottom: 4px;
        }

        .header p {
            font-size: 0.85rem;
            color: #6366f1;
            opacity: 0.8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .stat-card {
            background: white;
            padding: 12px 8px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
            border: 1px solid #f1f5f9;
        }

        .stat-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: #4f46e5;
            display: block;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .add-form {
            background: white;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #f1f5f9;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            padding: 10px 12px;
            border: 1.5px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: #fafafa;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #a78bfa;
            background: white;
            box-shadow: 0 0 0 2px rgba(167, 139, 250, 0.1);
        }

        .add-btn {
            width: 100%;
            background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 8px;
        }

        .add-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .section {
            background: white;
            border-radius: 16px;
            margin-bottom: 16px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            border: 1px solid #f1f5f9;
        }

        .section-header {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #92400e;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toggle-btn {
            background: rgba(146, 64, 14, 0.1);
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.75rem;
            color: #92400e;
            cursor: pointer;
        }

        .section-content {
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
        }

        .section-content.collapsed {
            max-height: 0;
            padding: 0 16px;
            overflow: hidden;
        }

        .item-list {
            list-style: none;
        }

        .item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.2s ease;
        }

        .item:last-child {
            border-bottom: none;
        }

        .item.completed {
            opacity: 0.6;
        }

        .item.completed .item-name {
            text-decoration: line-through;
            color: #10b981;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            margin-right: 12px;
            position: relative;
            cursor: pointer;
            background: white;
            transition: all 0.2s ease;
        }

        .checkbox.checked {
            background: #10b981;
            border-color: #10b981;
        }

        .checkbox.checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .item-content {
            flex: 1;
            min-width: 0;
        }

        .item-name {
            font-weight: 600;
            color: #334155;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .item-details {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .store-tag {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            color: #5b21b6;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .quantity-badge {
            background: #f0fdf4;
            color: #166534;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .priority-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .priority-high { background: #fca5a5; }
        .priority-medium { background: #fed7aa; }
        .priority-low { background: #bbf7d0; }

        .date-text {
            font-size: 0.7rem;
            color: #64748b;
        }

        .delete-btn {
            background: #fef2f2;
            border: none;
            border-radius: 6px;
            padding: 6px 8px;
            color: #dc2626;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #fee2e2;
        }

        .quick-actions {
            display: flex;
            gap: 6px;
            margin-bottom: 16px;
            overflow-x: auto;
            padding: 2px;
        }

        .quick-btn {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.75rem;
            color: #64748b;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .quick-btn:hover {
            background: #f8fafc;
            border-color: #c7d2fe;
            color: #4f46e5;
        }

        .empty-state {
            text-align: center;
            padding: 24px 16px;
            color: #94a3b8;
        }

        .empty-icon {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.5;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 8px;
            margin-bottom: 12px;
            align-items: end;
        }

        .filter-btn {
            background: linear-gradient(135deg, #67e8f9 0%, #06b6d4 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-left {
            flex: 1;
            min-width: 0;
        }

        .history-right {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .frequency-badge {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            color: #15803d;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Mobile optimizations */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }

            .header h1 {
                font-size: 1.25rem;
            }

            .stats-grid {
                gap: 6px;
            }

            .stat-card {
                padding: 8px 4px;
            }

            .stat-number {
                font-size: 1.1rem;
            }

            .add-form {
                padding: 12px;
            }

            .section-content {
                max-height: 250px;
            }
        }

        /* Scrollbar styling */
        .section-content::-webkit-scrollbar {
            width: 4px;
        }

        .section-content::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 2px;
        }

        .section-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        /* Animation classes */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üõí Smart Shopping</h1>
            <p>Your organized shopping companion</p>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="total-items">0</span>
                <span class="stat-label">Total</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="completed-items">0</span>
                <span class="stat-label">Done</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="unique-stores">0</span>
                <span class="stat-label">Stores</span>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <button class="quick-btn" onclick="clearCompleted()">üóëÔ∏è Clear Done</button>
            <button class="quick-btn" onclick="markAllComplete()">‚úÖ Complete All</button>
            <button class="quick-btn" onclick="exportList()">üì§ Export</button>
            <button class="quick-btn" onclick="groupByStore()">üè™ Group</button>
        </div>

        <!-- Add Item Form -->
        <div class="add-form">
            <div class="form-row">
                <div class="input-group">
                    <label for="item_name">Item Name</label>
                    <input type="text" id="item_name" placeholder="e.g., Milk, Bread..." required>
                </div>
                <div class="input-group">
                    <label for="quantity">Quantity</label>
                    <input type="number" id="quantity" placeholder="1" min="1" value="1" required>
                </div>
            </div>
            <div class="form-row">
                <div class="input-group">
                    <label for="store">Store</label>
                    <input type="text" id="store" placeholder="e.g., Conad, Maurys..." required>
                </div>
                <div class="input-group">
                    <label for="priority">Priority</label>
                    <select id="priority">
                        <option value="low">Low</option>
                        <option value="medium" selected>Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
            </div>
           <div class="form-row">
                <div class="input-group" style="flex: 1;">
                    <label for="needed_by">Needed By (Optional)</label>
                    <input type="date" id="needed_by">
                </div>
                <div class="input-group" style="display: flex; align-items: flex-end;">
                    <button class="add-btn" style="width: 100%;" onclick="addItem()">‚ûï Add Item</button>
                </div>
            </div>
        </div>

        <!-- Shopping List -->
        <div class="section">
            <div class="section-header">
                <span>üõçÔ∏è Shopping List</span>
                <button class="toggle-btn" onclick="toggleSection('shopping-list')">Hide</button>
            </div>
            <div class="section-content" id="shopping-list">
                <ul class="item-list" id="shopping_list_items">
                    <div class="empty-state">
                        <div class="empty-icon">üõí</div>
                        <div>Add some items to get started!</div>
                    </div>
                </ul>
            </div>
        </div>

        <!-- Purchase History -->
        <div class="section">
            <div class="section-header">
                <span>üìà Purchase History</span>
                <button class="toggle-btn" onclick="toggleSection('history')">Hide</button>
            </div>
            <div class="section-content" id="history">
                <div class="filter-row">
                    <div class="input-group">
                        <input type="date" id="start_timestamp" style="font-size: 0.8rem;">
                    </div>
                    <div class="input-group">
                        <input type="date" id="end_timestamp" style="font-size: 0.8rem;">
                    </div>
                    <button class="filter-btn" onclick="loadItemsByTimestamp()">Filter</button>
                </div>
                <div id="history_items">
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <div>No purchase history yet.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let shoppingData = [];
        let historicalData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentItems();
            updateStatistics();
            setDefaultDates();
            
            // Try to load historical data on startup
            setTimeout(() => {
                loadItemsByTimestamp();
            }, 1000);
        });

        function setDefaultDates() {
            const today = new Date();
            const oneMonthAgo = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
            
            document.getElementById('end_timestamp').value = today.toISOString().split('T')[0];
            document.getElementById('start_timestamp').value = oneMonthAgo.toISOString().split('T')[0];
        }

        async function loadCurrentItems() {
            try {
                // Try to fetch from API first
                const response = await fetch('/api/shopping-list/current');
                if (response.ok) {
                    shoppingData = await response.json();
                } else {
                    // Fallback to localStorage
                    shoppingData = JSON.parse(localStorage.getItem('shoppingList') || '[]');
                }
            } catch (error) {
                console.error('API unavailable, using localStorage:', error);
                shoppingData = JSON.parse(localStorage.getItem('shoppingList') || '[]');
            }
            
            renderCurrentItems();
            updateStatistics();
        }

        function renderCurrentItems() {
            const container = document.getElementById('shopping_list_items');
            
            if (shoppingData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üõí</div>
                        <div>Add some items to get started!</div>
                    </div>
                `;
                return;
            }

            container.innerHTML = shoppingData.map((item, index) => `
                <li class="item ${item.inCart ? 'completed' : ''} fade-in">
                    <div class="checkbox ${item.inCart ? 'checked' : ''}" onclick="toggleItemInCart(${index})"></div>
                    <div class="item-content">
                        <div class="item-name">${item.name || item.item_name}</div>
                        <div class="item-details">
                            <span class="store-tag">${item.store}</span>
                            <span class="quantity-badge">${item.quantity}</span>
                            <span class="priority-dot priority-${item.priority || 'medium'}"></span>
                            ${item.neededBy ? `<span class="date-text">${new Date(item.neededBy).toLocaleDateString()}</span>` : ''}
                        </div>
                    </div>
                    <button class="delete-btn" onclick="deleteItem(${index})">üóëÔ∏è</button>
                </li>
            `).join('');
        }

        function updateStatistics() {
            const total = shoppingData.length;
            const completed = shoppingData.filter(item => item.inCart).length;
            const uniqueStores = [...new Set(shoppingData.map(item => item.store))].length;

            document.getElementById('total-items').textContent = total;
            document.getElementById('completed-items').textContent = completed;
            document.getElementById('unique-stores').textContent = uniqueStores;
        }

        async function addItem() {
            const name = document.getElementById('item_name').value.trim();
            const store = document.getElementById('store').value.trim();
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            const neededBy = document.getElementById('needed_by').value;
            const priority = document.getElementById('priority').value;

            if (!name || !store) {
                alert('Please fill in item name and store');
                return;
            }

            const newItem = {
                id: Date.now(),
                name,
                item_name: name, // For API compatibility
                store,
                quantity,
                neededBy,
                priority,
                inCart: false,
                dateAdded: new Date().toISOString()
            };

            try {
                // Try to send to server
                const response = await fetch('/todolist/insert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        item_name: name,
                        store: store,
                        quantity: quantity,
                        priority: priority,
                        needed_by: neededBy
                    })
                });

                if (response.ok) {
                    console.log('Item added to server successfully');
                }
            } catch (error) {
                console.error('Server unavailable, using local storage:', error);
            }

            // Always update local state
            shoppingData.push(newItem);
            localStorage.setItem('shoppingList', JSON.stringify(shoppingData));
            
            // Clear form
            document.getElementById('item_name').value = '';
            document.getElementById('store').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('needed_by').value = '';
            document.getElementById('priority').value = 'medium';

            // Re-render and update stats
            renderCurrentItems();
            updateStatistics();
        }

        async function toggleItemInCart(index) {
            shoppingData[index].inCart = !shoppingData[index].inCart;

            // If item is being marked as in cart, move to history
            if (shoppingData[index].inCart) {
                const completedItem = {
                    ...shoppingData[index],
                    purchaseDate: new Date().toISOString(),
                    completedDate: new Date().toISOString(),
                    timestamp: new Date().toISOString().split('T')[0]
                };
                
                // Add to local history
                historicalData = JSON.parse(localStorage.getItem('shoppingHistory') || '[]');
                historicalData.push(completedItem);
                localStorage.setItem('shoppingHistory', JSON.stringify(historicalData));
                
                try {
                    // Try to send completion to server
                    await fetch(`/api/shopping-list/complete/${shoppingData[index].id}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            item_name: completedItem.name || completedItem.item_name,
                            store: completedItem.store,
                            quantity: completedItem.quantity,
                            timestamp: completedItem.timestamp
                        })
                    });
                } catch (error) {
                    console.error('Error saving completion to server:', error);
                }
            }

            localStorage.setItem('shoppingList', JSON.stringify(shoppingData));
            renderCurrentItems();
            updateStatistics();
        }

        async function deleteItem(index) {
            if (confirm('Are you sure you want to delete this item?')) {
                const deletedItem = shoppingData.splice(index, 1)[0];
                
                try {
                    await fetch(`/todolist/delete/${deletedItem._id}`, {
                        method: 'DELETE'
                    });
                } catch (error) {
                    console.error('Error deleting from server:', error);
                }

                localStorage.setItem('shoppingList', JSON.stringify(shoppingData));
                renderCurrentItems();
                updateStatistics();
            }
        }

        function clearCompleted() {
            const completedItems = shoppingData.filter(item => item.inCart);
            if (completedItems.length === 0) {
                alert('No completed items to clear!');
                return;
            }

            if (confirm(`Clear ${completedItems.length} completed items?`)) {
                shoppingData = shoppingData.filter(item => !item.inCart);
                localStorage.setItem('shoppingList', JSON.stringify(shoppingData));
                renderCurrentItems();
                updateStatistics();
            }
        }

        function markAllComplete() {
            if (shoppingData.length === 0) {
                alert('No items to complete!');
                return;
            }

            if (confirm('Mark all items as completed?')) {
                shoppingData.forEach((item, index) => {
                    if (!item.inCart) {
                        toggleItemInCart(index);
                    }
                });
            }
        }

        function exportList() {
            if (shoppingData.length === 0) {
                alert('No items to export!');
                return;
            }

            const exportData = {
                currentList: shoppingData,
                exportDate: new Date().toISOString(),
                statistics: {
                    totalItems: shoppingData.length,
                    completedItems: shoppingData.filter(item => item.inCart).length,
                    uniqueStores: [...new Set(shoppingData.map(item => item.store))].length
                }
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `shopping-list-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function groupByStore() {
            if (shoppingData.length === 0) return;

            const groupedData = {};
            shoppingData.forEach(item => {
                if (!groupedData[item.store]) {
                    groupedData[item.store] = [];
                }
                groupedData[item.store].push(item);
            });

            const container = document.getElementById('shopping_list_items');
            let html = '';

            Object.keys(groupedData).sort().forEach(store => {
                html += `<li style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 8px 12px; border-radius: 8px; margin-bottom: 8px; font-weight: 600; color: #4f46e5;">üè™ ${store} (${groupedData[store].length})</li>`;
                
                groupedData[store].forEach((item) => {
                    const actualIndex = shoppingData.findIndex(i => i.id === item.id);
                    html += `
                        <li class="item ${item.inCart ? 'completed' : ''}" style="margin-left: 16px;">
                            <div class="checkbox ${item.inCart ? 'checked' : ''}" onclick="toggleItemInCart(${actualIndex})"></div>
                            <div class="item-content">
                                <div class="item-name">${item.name || item.item_name}</div>
                                <div class="item-details">
                                    <span class="store-tag">${item.store}</span>
                                    <span class="quantity-badge">${item.quantity}</span>
                                    <span class="priority-dot priority-${item.priority || 'medium'}"></span>
                                    ${item.neededBy ? `<span class="date-text">${new Date(item.neededBy).toLocaleDateString()}</span>` : ''}
                                </div>
                            </div>
                            <button class="delete-btn" onclick="deleteItem(${actualIndex})">üóëÔ∏è</button>
                        </li>
                    `;
                });
            });

            container.innerHTML = html;
        }

        async function loadItemsByTimestamp() {
            const startDate = document.getElementById('start_timestamp').value;
            const endDate = document.getElementById('end_timestamp').value;

            if (!startDate || !endDate) {
                alert('Please select both dates');
                return;
            }

            // Show loading state
            const container = document.getElementById('history_items');
            container.innerHTML = `
                <div class="empty-state">
                    <div class="loading"></div>
                    <div style="margin-top: 8px;">Loading history...</div>
                </div>
            `;

            try {
                // Try to fetch from API first
                const response = await fetch(`/todolist/update/${startDate}/${endDate}`);
                if (response.ok) {
                    const data = await response.json();
                    renderHistoricalData(data);
                    return;
                }
            } catch (error) {
                console.error('API call failed, using localStorage:', error);
            }

            // Fallback to localStorage
            const allHistory = JSON.parse(localStorage.getItem('shoppingHistory') || '[]');
            const filteredData = allHistory.filter(item => {
                const itemDate = new Date(item.purchaseDate || item.timestamp);
                return itemDate >= new Date(startDate) && itemDate <= new Date(endDate);
            });

            renderHistoricalData(filteredData);
        }

        function renderHistoricalData(data) {
            const container = document.getElementById('history_items');
            
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <div>No purchase history found.</div>
                    </div>
                `;
                return;
            }

            // Calculate frequency for each item
            const itemFrequency = {};
            data.forEach(item => {
                // Handle both API format (item_name) and localStorage format (name)
                const itemName = item.item_name || item.name;
                const key = `${itemName}-${item.store}`;
                itemFrequency[key] = (itemFrequency[key] || 0) + 1;
            });

            // Group items by name and store
            const groupedItems = {};
            data.forEach(item => {
                const itemName = item.item_name || item.name;
                const key = `${itemName}-${item.store}`;
                if (!groupedItems[key]) {
                    groupedItems[key] = {
                        name: itemName,
                        store: item.store,
                        frequency: itemFrequency[key],
                        totalQuantity: 0,
                        lastPurchased: item.timestamp || item.purchaseDate || item.completedDate
                    };
                }
                groupedItems[key].totalQuantity += parseInt(item.quantity) || 0;
                
                // Keep the most recent date
                const currentDate = item.timestamp || item.purchaseDate || item.completedDate;
                if (new Date(currentDate) > new Date(groupedItems[key].lastPurchased)) {
                    groupedItems[key].lastPurchased = currentDate;
                }
            });

            // Sort by frequency (most bought first)
            const sortedItems = Object.values(groupedItems).sort((a, b) => b.frequency - a.frequency);

            container.innerHTML = sortedItems.map(item => `
                <div class="history-item fade-in">
                    <div class="history-left">
                        <div class="item-name">${item.name}</div>
                        <div class="item-details">
                            <span class="store-tag">${item.store}</span>
                            <span class="quantity-badge">${item.totalQuantity}</span>
                            <span class="date-text">${new Date(item.lastPurchased).toLocaleDateString()}</span>
                        </div>
                    </div>
                    <div class="history-right">
                        <span class="frequency-badge">${item.frequency}x</span>
                    </div>
                </div>
            `).join('');
        }

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            const btn = section.previousElementSibling.querySelector('.toggle-btn');
            
            section.classList.toggle('collapsed');
            btn.textContent = section.classList.contains('collapsed') ? 'Show' : 'Hide';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                addItem();
            }
            
            // Focus on item name input with Ctrl/Cmd + K
            if (e.key === 'k' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                document.getElementById('item_name').focus();
            }
            
            // Export with Ctrl/Cmd + E
            if (e.key === 'e' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                exportList();
            }
        });

        // Auto-save functionality
        setInterval(() => {
            localStorage.setItem('shoppingList', JSON.stringify(shoppingData));
            if (historicalData.length > 0) {
                localStorage.setItem('shoppingHistory', JSON.stringify(historicalData));
            }
        }, 30000); // Save every 30 seconds

        // Smart suggestions based on history
        function setupSmartSuggestions() {
            const itemInput = document.getElementById('item_name');
            const storeInput = document.getElementById('store');
            
            // Get historical data for suggestions
            const getHistoricalItems = () => {
                return JSON.parse(localStorage.getItem('shoppingHistory') || '[]');
            };
            
            itemInput.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                if (value.length < 2) return;
                
                const historicalItems = getHistoricalItems();
                const suggestions = [...new Set(historicalItems
                    .filter(item => (item.item_name || item.name || '').toLowerCase().includes(value))
                    .map(item => item.item_name || item.name)
                    .slice(0, 5))];
                
                // You can implement a dropdown suggestion UI here if needed
                console.log('Item suggestions:', suggestions);
            });

            storeInput.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                if (value.length < 1) return;
                
                const historicalItems = getHistoricalItems();
                const suggestions = [...new Set(historicalItems
                    .filter(item => item.store.toLowerCase().includes(value))
                    .map(item => item.store)
                    .slice(0, 5))];
                
                console.log('Store suggestions:', suggestions);
            });
        }

        // Initialize smart suggestions
        setupSmartSuggestions();

        // Service Worker for offline functionality (optional)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(err => {
                console.log('Service Worker registration failed:', err);
            });
        }

        // Handle online/offline status
        window.addEventListener('online', function() {
            console.log('Back online - syncing data...');
            // You could implement data sync here
        });

        window.addEventListener('offline', function() {
            console.log('Gone offline - using local storage...');
        });

        // Responsive adjustments
        function adjustForMobile() {
            if (window.innerWidth <= 480) {
                // Reduce section heights on very small screens
                const sections = document.querySelectorAll('.section-content');
                sections.forEach(section => {
                    if (!section.classList.contains('collapsed')) {
                        section.style.maxHeight = '200px';
                    }
                });
            }
        }

        window.addEventListener('resize', adjustForMobile);
        adjustForMobile(); // Run on load

        // Initialize tooltips for better UX
        function addTooltips() {
            const tooltipElements = [
                { id: 'item_name', text: 'Enter the name of the item you want to buy' },
                { id: 'quantity', text: 'How many do you need?' },
                { id: 'store', text: 'Which store will you buy this from?' },
                { id: 'priority', text: 'How urgent is this item?' },
                { id: 'needed_by', text: 'When do you need this by?' }
            ];

            tooltipElements.forEach(elem => {
                const element = document.getElementById(elem.id);
                if (element) {
                    element.title = elem.text;
                }
            });
        }

        addTooltips();

        // Performance optimization: Debounce expensive operations
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Debounced render function for better performance
        const debouncedRender = debounce(renderCurrentItems, 100);
        const debouncedUpdateStats = debounce(updateStatistics, 100);

        // Error handling and user feedback
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 16px;
                border-radius: 8px;
                color: white;
                font-size: 14px;
                font-weight: 500;
                z-index: 1000;
                animation: slideIn 0.3s ease-out;
                max-width: 300px;
                background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // Enhanced error handling for API calls
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                showToast('Network error. Using offline mode.', 'error');
                throw error;
            }
        }

        // Data validation
        function validateItem(item) {
            const errors = [];
            
            if (!item.name && !item.item_name) {
                errors.push('Item name is required');
            }
            
            if (!item.store) {
                errors.push('Store is required');
            }
            
            if (item.quantity < 1) {
                errors.push('Quantity must be at least 1');
            }
            
            return {
                isValid: errors.length === 0,
                errors
            };
        }

        // Export functionality with multiple formats
        function exportToCSV() {
            if (shoppingData.length === 0) {
                showToast('No items to export!', 'error');
                return;
            }

            const headers = ['Name', 'Store', 'Quantity', 'Priority', 'Needed By', 'Status'];
            const csvContent = [
                headers.join(','),
                ...shoppingData.map(item => [
                    `"${item.name || item.item_name}"`,
                    `"${item.store}"`,
                    item.quantity,
                    item.priority || 'medium',
                    item.neededBy || '',
                    item.inCart ? 'Completed' : 'Pending'
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `shopping-list-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showToast('List exported successfully!', 'success');
        }

        // Add CSV export option to quick actions
        document.addEventListener('DOMContentLoaded', function() {
            const quickActions = document.querySelector('.quick-actions');
            const csvBtn = document.createElement('button');
            csvBtn.className = 'quick-btn';
            csvBtn.innerHTML = 'üìä CSV Export';
            csvBtn.onclick = exportToCSV;
            quickActions.appendChild(csvBtn);
        });

        console.log('üõí Smart Shopping List loaded successfully!');
        console.log('Keyboard shortcuts:');
        console.log('- Ctrl/Cmd + Enter: Add item');
        console.log('- Ctrl/Cmd + K: Focus on item input');
        console.log('- Ctrl/Cmd + E: Export list');
    </script>
</body>
</html>