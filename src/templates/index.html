<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperature and Humidity Dashboard</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 20px 0;
            background: linear-gradient(135deg, #f8f9ff 0%, #ffffff 50%, #f0f4f8 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        /* Subtle animated background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(239, 68, 68, 0.02) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(16, 185, 129, 0.02) 0%, transparent 50%);
            animation: floatPattern 30s ease-in-out infinite;
            pointer-events: none;
            z-index: -1;
        }

        @keyframes floatPattern {
            0%, 100% { 
                transform: translate(0, 0) rotate(0deg); 
                opacity: 0.6;
            }
            50% { 
                transform: translate(20px, -20px) rotate(180deg); 
                opacity: 0.8;
            }
        }

        h1 {
            color: #1f2937;
            margin: 20px 0 30px 0;
            font-size: 2rem;
            text-align: center;
            font-weight: 700;
            letter-spacing: -0.5px;
            position: relative;
            animation: fadeInDown 0.8s ease-out;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            border-radius: 2px;
            animation: expandLine 1s ease-out 0.5s both;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes expandLine {
            from { width: 0; opacity: 0; }
            to { width: 60px; opacity: 1; }
        }

        /* Dark mode styles */
        body.dark-mode {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
        }

        body.dark-mode::before {
            background: 
                radial-gradient(circle at 20% 80%, rgba(79, 172, 254, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(142, 68, 173, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(239, 71, 111, 0.05) 0%, transparent 50%);
        }

        body.dark-mode h1 {
            color: #f8fafc;
        }

        body.dark-mode h1::after {
            background: linear-gradient(90deg, #60a5fa, #a78bfa, #f472b6);
        }

        .cards-container {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            width: 90%;
            max-width: 1000px;
            justify-content: center;
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 0.3s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.08),
                0 1px 4px rgba(0, 0, 0, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            text-align: center;
            font-size: 12px;
            flex: 1 1 calc(30% - 16px);
            min-width: 160px;
            max-width: 200px;
            height: 130px;
            box-sizing: border-box;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.6s ease;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 
                0 12px 32px rgba(0, 0, 0, 0.12),
                0 4px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            border-color: rgba(255, 255, 255, 0.9);
        }

        .card:active {
            transform: translateY(-3px) scale(1.01);
            transition: all 0.15s ease;
        }

        .card p {
            margin: 4px 0;
            word-wrap: break-word;
            font-size: 12px;
            color: inherit;
        }

        .card h2 {
            margin: 8px 0 12px 0;
            font-size: 1rem;
            font-weight: 600;
            color: inherit;
        }

        /* Enhanced gradients with better contrast for white background */
        .card.temperature {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 50%, #f59e0b 100%);
            color: #92400e;
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.2);
        }

        .card.temperature:hover {
            box-shadow: 0 12px 32px rgba(251, 191, 36, 0.3);
        }

        .card.humidity {
            background: linear-gradient(135deg, #dbeafe 0%, #3b82f6 50%, #1d4ed8 100%);
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.2);
        }

        .card.humidity:hover {
            box-shadow: 0 12px 32px rgba(59, 130, 246, 0.3);
        }

        .card.raspberry-pi {
            background: linear-gradient(135deg, #fce7f3 0%, #ec4899 50%, #be185d 100%);
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(236, 72, 153, 0.2);
        }

        .card.raspberry-pi:hover {
            box-shadow: 0 12px 32px rgba(236, 72, 153, 0.3);
        }

        .card.transports {
            background: linear-gradient(135deg, #ecfdf5 0%, #10b981 50%, #047857 100%);
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
        }

        .card.transports:hover {
            box-shadow: 0 12px 32px rgba(16, 185, 129, 0.3);
        }

        .card.devices {
            background: linear-gradient(135deg, #f3e8ff 0%, #8b5cf6 50%, #6d28d9 100%);
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.2);
        }

        .card.devices:hover {
            box-shadow: 0 12px 32px rgba(139, 92, 246, 0.3);
        }

        .card.alarm.green {
            background: linear-gradient(135deg, #dcfce7 0%, #22c55e 50%, #15803d 100%);
            color: #ffffff;
            animation: pulseGreen 3s ease-in-out infinite;
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.25);
        }

        .card.alarm.red {
            background: linear-gradient(135deg, #fee2e2 0%, #ef4444 50%, #dc2626 100%);
            color: #ffffff;
            animation: pulseRed 3s ease-in-out infinite;
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.25);
        }

        @keyframes pulseGreen {
            0%, 100% { 
                box-shadow: 0 4px 16px rgba(34, 197, 94, 0.25);
                transform: scale(1); 
            }
            50% { 
                box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
                transform: scale(1.02); 
            }
        }

        @keyframes pulseRed {
            0%, 100% { 
                box-shadow: 0 4px 16px rgba(239, 68, 68, 0.25);
                transform: scale(1); 
            }
            50% { 
                box-shadow: 0 8px 24px rgba(239, 68, 68, 0.4);
                transform: scale(1.02); 
            }
        }

        .card.list {
            background: linear-gradient(135deg, #ede9fe 0%, #ed8d0e 50%, #ea4e36 100%);
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(168, 85, 247, 0.2);
        }

        .card.list:hover {
            box-shadow: 0 12px 32px rgba(168, 85, 247, 0.3);
        }

        .card.air-quality {
            color: #ffffff;
            cursor: pointer;
            position: relative;
        }

        .card.air-quality::after {
            content: '';
            position: absolute;
            top: 16px;
            right: 16px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            animation: breathe 2s ease-in-out infinite;
        }

        @keyframes breathe {
            0%, 100% { 
                opacity: 0.6; 
                transform: scale(1);
            }
            50% { 
                opacity: 1; 
                transform: scale(1.3);
            }
        }

        .card.air-quality.ottimo {
            background: linear-gradient(135deg, #dcfce7 0%, #22c55e 50%, #15803d 100%);
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.2);
        }

        .card.air-quality.buono {
            background: linear-gradient(135deg, #f0f9ff 0%, #0ea5e9 50%, #0284c7 100%);
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.2);
        }

        .card.air-quality.moderato {
            background: linear-gradient(135deg, #fefce8 0%, #eab308 50%, #ca8a04 100%);
            box-shadow: 0 4px 16px rgba(234, 179, 8, 0.2);
        }

        .card.air-quality.scadente {
            background: linear-gradient(135deg, #fff7ed 0%, #f97316 50%, #ea580c 100%);
            box-shadow: 0 4px 16px rgba(249, 115, 22, 0.2);
        }

        .card.air-quality.molto-scadente {
            background: linear-gradient(135deg, #fef2f2 0%, #ef4444 50%, #dc2626 100%);
            box-shadow: 0 4px 16px rgba(239, 68, 68, 0.2);
        }

        .card.air-quality.pericoloso {
            background: linear-gradient(135deg, #f9fafb 0%, #6b7280 50%, #374151 100%);
            box-shadow: 0 4px 16px rgba(107, 114, 128, 0.3);
        }

        .card#expensesCard {
            background: linear-gradient(135deg, #f0fdfa 0%, #14b8a6 50%, #0f766e 100%);
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(20, 184, 166, 0.2);
        }

        .card#expensesCard:hover {
            box-shadow: 0 12px 32px rgba(20, 184, 166, 0.3);
        }

        .card#saldoCard {
            background: linear-gradient(135deg, #faf5ff 0%, #b168f4 50%, #9333ea 100%);
            color: #ffffff;
            box-shadow: 0 4px 16px rgba(147, 51, 234, 0.2);
        }

        .card#saldoCard:hover {
            box-shadow: 0 12px 32px rgba(147, 51, 234, 0.3);
        }

        /* Dark mode card adjustments */
        body.dark-mode .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(71, 85, 105, 0.3);
            color: #f8fafc;
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.2),
                0 1px 4px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(148, 163, 184, 0.1);
        }

        body.dark-mode .card:hover {
            background: rgba(30, 41, 59, 0.9);
            box-shadow: 
                0 12px 32px rgba(0, 0, 0, 0.3),
                0 4px 8px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(148, 163, 184, 0.15);
            border-color: rgba(71, 85, 105, 0.4);
        }

        /* Enhanced toggle switch */
        .switch {
            position: absolute;
            top: 20px;
            right: 20px;
            display: inline-block;
            width: 60px;
            height: 34px;
            z-index: 1000;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 34px;
            box-shadow: 
                inset 0 2px 4px rgba(0, 0, 0, 0.1),
                0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.15),
                0 1px 2px rgba(0, 0, 0, 0.1);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .slider:active:before {
            width: 30px;
        }

        /* Button styling */
        .card.list button {
            background: rgba(255, 255, 255, 0.2);
            color: inherit;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            padding: 12px 16px;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-weight: 500;
        }

        .card.list button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Responsive design */
        @media (max-width: 600px) {
            .card {
                flex: 1 1 calc(45% - 16px);
                max-width: 180px;
                height: 120px;
                padding: 16px;
            }
            
            h1 {
                font-size: 1.5rem;
                margin: 15px 0 20px 0;
            }

            .cards-container {
                gap: 12px;
                width: 95%;
            }
        }

        /* Value styling */
        .card.temperature h2#temperatureValue,
        .card.air-quality h2#airqualityValue,
        .card.humidity h2#humidityValue,
        .card.air-quality h2#airQualityIndex,
        .card h2#saldoValue,
        .card h2#alarmStatus {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 4px 0;
        }

        /* Loading animation */
        .loading {
            position: relative;
            overflow: hidden;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Entrance animations */
        .card {
            animation: cardEntrance 0.6s ease-out backwards;
        }

        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .card:nth-child(3) { animation-delay: 0.3s; }
        .card:nth-child(4) { animation-delay: 0.4s; }
        .card:nth-child(5) { animation-delay: 0.5s; }
        .card:nth-child(6) { animation-delay: 0.6s; }
        .card:nth-child(7) { animation-delay: 0.7s; }
        .card:nth-child(8) { animation-delay: 0.8s; }
        .card:nth-child(9) { animation-delay: 0.9s; }
        .card:nth-child(10) { animation-delay: 1.0s; }

        @keyframes cardEntrance {
            from {
                opacity: 0;
                transform: translateY(15px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
</head>

<body>
    <h1>Smart Homes</h1>

    <!-- Dark Mode Toggle Switch -->
    <label class="switch">
        <input type="checkbox" id="toggleDarkMode">
        <span class="slider"></span>
    </label>

    <div class="cards-container">
        <!-- Temperature Card -->
        <div class="card temperature" id="temperatureCard">
            <h2>Temperature</h2>
            <h2 id="temperatureValue">-- °C</h2>
            <p><span id="tempMinMax">-- / --</span></p>
        </div>

        <!-- Humidity Card -->
        <div class="card humidity" id="humidityCard">
            <h2>Humidity</h2>
            <h2 id="humidityValue">-- %</h2>
            <p><span id="humidityMinMax">-- / --</span></p>
        </div>

         <!-- Air Quality Card -->
         <div class="card air-quality" id="airQualityCard">
            <h2>Air Quality</h2>
            <h2 id="airQualityIndex">--</h2>
            <p><span id="airQualityStatus">Loading...</span></p>
        </div>

        <!-- Raspberry Pi Stats Card -->
        <div class="card raspberry-pi" id="raspberryPiCard">
            <h2>Raspberry Pi</h2>
        </div>

        <!-- Transports Card -->
        <div class="card transports" id="transportsCard">
            <h2>Travel</h2>
        </div>

        <!-- Device Card -->
        <div class="card devices" id="deviceCard">
            <h2>Home Security</h2>
        </div>

        <div class="card list" id="shoppingListCard">
            <h2>Shopping List</h2>
        </div>

        <div class="card list" id="expensesCard">
            <h2>Expenses</h2>
        </div>

        <!-- Saldo Card -->
        <div class="card list" id="saldoCard">
            <h2>Saldo</h2>
            <h2 id="saldoValue">-- €</h2>
        </div>

        <!-- Alarm Card -->
        <div class="card alarm" id="alarmCard">
            <h2>Home Alarm</h2>
            <h2 id="alarmStatus">OFF</h2>
        </div>
    </div>

    <script>
        // Funzione per aprire nuove pagine in base alla card cliccata
        document.getElementById("temperatureCard").addEventListener("click", () => {
            window.location.href = "/temp";
        });

        document.getElementById("humidityCard").addEventListener("click", () => {
            window.location.href = "/umid";
        });

        document.getElementById("raspberryPiCard").addEventListener("click", () => {
            window.location.href = "/raspi";
        });

        document.getElementById("expensesCard").addEventListener("click", () => {
            window.location.href = "/expenses";
        });

        document.getElementById("transportsCard").addEventListener("click", () => {
            window.location.href = "/train";
        });

        document.getElementById("deviceCard").addEventListener("click", () => {
            window.location.href = "/security";
        });

        document.getElementById("airQualityCard").addEventListener("click", () => {
            window.location.href = "/air_quality";
        });

        // Function to format the timestamp to only time
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        async function fetchData() {
            try {
                const response = await fetch('/api_sensors');
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        async function fetchSaldoValue() {
            const saldoElement = document.getElementById("saldoValue");
            const saldoCard = document.getElementById("saldoCard");
            
            // Add loading animation
            saldoCard.classList.add('loading');

            try {
                const response = await fetch('/api/p48');
                const data = await response.json();

                // Show cached value immediately
                if (data.cached_value !== undefined && data.cached_value !== null) {
                    saldoElement.textContent = `${parseFloat(data.cached_value).toFixed(2)} €`;
                }

                // Override with updated value if available
                if (data.P48_value !== undefined && data.P48_value !== null) {
                    saldoElement.textContent = `${parseFloat(data.P48_value).toFixed(2)} €`;
                }

            } catch (error) {
                console.error("Errore nel recuperare il saldo da P48:", error);
                saldoElement.textContent = "-- €";
            } finally {
                saldoCard.classList.remove('loading');
            }
        }

        async function fetchDevices() {
            try {
                const response = await fetch('/api/devices');
                const devices = await response.json();
                return devices;
            } catch (error) {
                console.error('Error fetching devices:', error);
                return [];
            }
        }

        async function updateUI() {
            const data = await fetchData();
            const devices = await fetchDevices();

            if (!data) return;

            // Update current temperature and humidity with smooth animation
            const tempElement = document.getElementById("temperatureValue");
            const humidElement = document.getElementById("humidityValue");
            
            tempElement.textContent = `${parseFloat(data.temperature.current).toFixed(1)} °C`;
            humidElement.textContent = `${parseFloat(data.humidity.current).toFixed(0)} %`;

            // Update min/max temperature and humidity
            document.getElementById("tempMinMax").textContent =
                `${data.temperature.minMaxLast24Hours[0] === 'inf' ? 'N/A' : parseFloat(data.temperature.minMaxLast24Hours[0]).toFixed(2)} / ${data.temperature.minMaxLast24Hours[1] === '-inf' ? 'N/A' : parseFloat(data.temperature.minMaxLast24Hours[1]).toFixed(2)}`;
            document.getElementById("humidityMinMax").textContent =
                `${data.humidity.minMaxLast24Hours[0] === 'inf' ? 'N/A' : parseFloat(data.humidity.minMaxLast24Hours[0]).toFixed(2)} / ${data.humidity.minMaxLast24Hours[1] === '-inf' ? 'N/A' : parseFloat(data.humidity.minMaxLast24Hours[1]).toFixed(2)}`;

            // Update devices section
            const deviceDetails = devices.map(device =>
                `<p>${device.hostname} - Last Seen: ${formatTimestamp(device.timestamp)}</p>`
            ).join('<br>');
        }

        // Function to fetch the last alarm status and update the color
        async function fetchLastAlarmStatus() {
            try {
                const response = await fetch('/security/alarm', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                const [status, _] = await response.json();

                // Set the card's state and color based on the alarm status
                const alarmCard = document.getElementById("alarmCard");
                const alarmStatus = document.getElementById("alarmStatus");

                if (status === "true") {
                    alarmCard.classList.add("green");
                    alarmCard.classList.remove("red");
                    alarmStatus.textContent = "ON";
                } else if (status === "false") {
                    alarmCard.classList.add("red");
                    alarmCard.classList.remove("green");
                    alarmStatus.textContent = "OFF";
                }
            } catch (error) {
                console.error('Error fetching last alarm status:', error);
            }
        }

        // Function to toggle alarm state with enhanced animation
        async function toggleAlarm() {
            const alarmCard = document.getElementById("alarmCard");
            const alarmStatus = document.getElementById("alarmStatus");

            // Add click feedback
            alarmCard.style.transform = 'scale(0.95)';
            setTimeout(() => {
                alarmCard.style.transform = '';
            }, 150);

            // Determine current status and toggle
            const isOn = alarmCard.classList.contains("green");

            // Set the displayed status (ON or OFF)
            alarmStatus.textContent = isOn ? "OFF" : "ON";

            // Send the new status to the server
            const alarmData = { status: !isOn };

            try {
                const response = await fetch('/security/alarm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(alarmData),
                });

                if (response.ok) {
                    console.log('Alarm status updated successfully.');
                    fetchLastAlarmStatus();
                } else {
                    console.error('Failed to update alarm status.');
                }
            } catch (error) {
                console.error('Error posting alarm status:', error);
            }
        }

        // Add click event listener to the alarm card
        document.getElementById('alarmCard').addEventListener('click', toggleAlarm);

        // Function to load the current theme with enhanced transition
        function loadTheme() {
            const darkMode = localStorage.getItem("darkMode") || "disabled";
            const bodyElement = document.body;
            const toggleDarkMode = document.getElementById("toggleDarkMode");

            if (darkMode === "enabled") {
                bodyElement.classList.add("dark-mode");
                toggleDarkMode.checked = true;
            } else {
                bodyElement.classList.remove("dark-mode");
                toggleDarkMode.checked = false;
            }
        }

        // Enhanced dark mode toggle with smooth transition
        function toggleDarkMode() {
            const bodyElement = document.body;
            const darkModeEnabled = bodyElement.classList.toggle("dark-mode");

            // Add transition class for smooth color changes
            bodyElement.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';

            if (darkModeEnabled) {
                localStorage.setItem("darkMode", "enabled");
            } else {
                localStorage.setItem("darkMode", "disabled");
            }

            // Remove transition class after animation completes
            setTimeout(() => {
                bodyElement.style.transition = '';
            }, 400);
        }

        // Load the theme when the page loads
        document.addEventListener("DOMContentLoaded", loadTheme);

        // Add event listener for the dark mode toggle switch
        document.getElementById("toggleDarkMode").addEventListener("change", toggleDarkMode);

        // Enhanced shopping list navigation
        document.getElementById("shoppingListCard").addEventListener("click", () => {
            window.location.href = "/lista-spesa";
        });

        async function fetchAirQuality() {
            const airQualityCard = document.getElementById("airQualityCard");
            airQualityCard.classList.add('loading');

            try {
                const response = await fetch('https://192.168.178.101:4443/api/air_quality');
                const data = await response.json();

                const { air_quality_index, air_quality_description, timestamp } = data[0];

                const airQualityIndexElement = document.getElementById("airQualityIndex");
                const airQualityStatus = document.getElementById("airQualityStatus");

                // Animate value changes
                airQualityIndexElement.style.transform = 'scale(0.8)';
                setTimeout(() => {
                    airQualityIndexElement.textContent = `${air_quality_index.toFixed(1)}`;
                    airQualityStatus.textContent = `${air_quality_description}`;
                    airQualityIndexElement.style.transform = 'scale(1)';
                }, 200);

                // Remove previous quality classes
                airQualityCard.classList.remove("ottimo", "buono", "moderato", "scadente", "molto-scadente", "pericoloso");

                // Update card color based on air quality index
                if (air_quality_index <= 20) {
                    airQualityCard.classList.add("molto-scadente");
                } else if (air_quality_index <= 40) {
                    airQualityCard.classList.add("scadente");
                } else if (air_quality_index <= 60) {
                    airQualityCard.classList.add("moderato");
                } else if (air_quality_index <= 80) {
                    airQualityCard.classList.add("buono");
                } else if (air_quality_index <= 100) {
                    airQualityCard.classList.add("buono");
                } else {
                    airQualityCard.classList.add("ottimo");
                }
            } catch (error) {
                console.error('Error fetching air quality data:', error);
            } finally {
                airQualityCard.classList.remove('loading');
            }
        }

        // Enhanced initialization with staggered loading
        window.onload = () => {
            loadTheme();
            
            // Stagger the API calls for better UX
            setTimeout(() => updateUI(), 100);
            setTimeout(() => fetchSaldoValue(), 200);
            setTimeout(() => fetchLastAlarmStatus(), 300);
            setTimeout(() => fetchAirQuality(), 400);
        };

        // Add click event for manual air quality refresh
        document.getElementById("airQualityCard").addEventListener("click", fetchAirQuality);

        // Enhanced card interaction feedback
        document.querySelectorAll('.card').forEach(card => {
            card.addEventListener('mousedown', () => {
                card.style.transform = 'translateY(-3px) scale(0.98)';
            });
            
            card.addEventListener('mouseup', () => {
                card.style.transform = '';
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.transform = '';
            });
        });

        // Add loading states for better UX
        function addLoadingState(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('loading');
            }
        }

        function removeLoadingState(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('loading');
            }
        }

        // Enhanced error handling with user feedback
        function showErrorState(elementId, errorMessage = 'Error loading data') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = errorMessage;
                element.style.color = '#ef4444';
            }
        }

        // Auto-refresh data every 5 minutes
        setInterval(() => {
            updateUI();
            fetchSaldoValue();
            fetchAirQuality();
        }, 5 * 60 * 1000);

        // Add subtle parallax effect on scroll
        let ticking = false;
        function updateParallax() {
            const scrolled = window.pageYOffset;
            const rate = scrolled * -0.5;
            
            document.body.style.transform = `translateY(${rate}px)`;
            
            ticking = false;
        }

        function requestTick() {
            if (!ticking) {
                requestAnimationFrame(updateParallax);
                ticking = true;
            }
        }

        window.addEventListener('scroll', requestTick);

        // Add service worker for offline functionality (optional)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>

</html>